on: 
  workflow_call:
    inputs:
      env:
        required: false
        type: string
      module:
        required: true
        type: string
      moduleName:
        required: false
        type: string
      version:
        required: true
        type: string
        
jobs:
  cache: 
    uses: Labman4/workflow/.github/workflows/maven.yml@cache

  buildpacks:
    needs: cache
    environment: native-image
    runs-on: ubuntu-latest
#     timeout-minutes: 10
#     strategy:
#       fail-fast: true
    steps:      
    - uses: actions/checkout@d0651293c4a5a52e711f25b41b05b2212f385d28

    - uses: ScribeMD/docker-cache@0.2.7
      with:
        key: docker-${{ runner.os }}-${{ github.workflow_ref }}
     
    - uses: Labman4/workflow/.github/workflows/graalvm.yml@set-up        
        
    - run: |
        echo "path=$(pwd)" >> $GITHUB_ENV
        echo "home=$HOME" >> $GITHUB_ENV
        java --version

    - run: |
          mvn package install -DskipTests
          
    - uses: labman4/buildpacks-action@master
      with:
        image:  ${{ inputs.module }}
        tag: ${{ inputs.version }}
        path: '${{ env.path }}/${{ inputs.module }}/${{ inputs.moduleName }}'
        builder: 'paketobuildpacks/builder:0.1.303-tiny'
        env: 'BP_JVM_VERSION=17.0.5 BP_NATIVE_IMAGE=false'
        map_env: 'BP_MAVEN_BUILD_ARGUMENTS="-Dmaven.test.skip=true --no-transfer-progress package "'
        volume: ${{ env.home }}
        
 
    - name: Push To hub
      uses: redhat-actions/push-to-registry@v2.7
      with:
        image: ${{ inputs.module }}
        registry: docker.io/labman4
        tags: ${{ inputs.version }}
        username:  ${{ secrets.REGISTRY_NAME }}
        password:  ${{ secrets.REGISTRY_PASS }}  
      
    - name: Push To quay
      uses: redhat-actions/push-to-registry@v2.7
      with:
        image: ${{ inputs.module }}
        registry: quay.io/elpsykongroo
        tags: ${{ inputs.version }}
        username:  ${{ secrets.QUAY_REGISTRY_NAME }}
        password:  ${{ secrets.QUAY_REGISTRY_PASS }}
        
#     - name: Push To harbor
#       uses: redhat-actions/push-to-registry@v2.7
#       continue-on-error: true
#       with:
#         image: ${{ inputs.module }}
#         registry: registry.elpsykongroo.com/library
#         tags: ${{ inputs.version }}
#         username:  ${{ secrets.REGISTRY_PRIVATE_NAME }}
#         password:  ${{ secrets.REGISTRY_PRIVATE_PASS }}
        
  deploy:
    needs: buildpacks
    uses: Labman4/workflow/.github/workflows/deploy.yml@deploy
    with: 
      module: ${{ inputs.module }}
      env: ${{ inputs.env }}
